<!-- Step Section Start -->
<section class="step-section pt-5 pb-2">
    <div
        class="container d-flex gap-3 align-items-center justify-content-center"
    >
        <div class="step-boat">
            <div
                class="circle checked mx-auto d-flex justify-content-center align-items-center"
            >
                <i class="fa-solid fa-check"></i>
            </div>
            <h5 class="mb-0 mt-2 text-center">CHOOSE BOAT</h5>
        </div>
        <svg
            width="162"
            height="24"
            viewBox="0 0 162 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
        >
            <path
                d="M161.061 13.0607C161.646 12.4749 161.646 11.5251 161.061 10.9393L151.515 1.3934C150.929 0.807611 149.979 0.807611 149.393 1.3934C148.808 1.97919 148.808 2.92893 149.393 3.51472L157.879 12L149.393 20.4853C148.808 21.0711 148.808 22.0208 149.393 22.6066C149.979 23.1924 150.929 23.1924 151.515 22.6066L161.061 13.0607ZM0 13.5H2V10.5H0V13.5ZM6 13.5H10V10.5H6V13.5ZM14 13.5H18V10.5H14V13.5ZM22 13.5H26V10.5H22V13.5ZM30 13.5H34V10.5H30V13.5ZM38 13.5H42V10.5H38V13.5ZM46 13.5H50V10.5H46V13.5ZM54 13.5H58V10.5H54V13.5ZM62 13.5H66V10.5H62V13.5ZM70 13.5H74V10.5H70V13.5ZM78 13.5H82V10.5H78V13.5ZM86 13.5H90V10.5H86V13.5ZM94 13.5H98V10.5H94V13.5ZM102 13.5H106V10.5H102V13.5ZM110 13.5H114V10.5H110V13.5ZM118 13.5H122V10.5H118V13.5ZM126 13.5H130V10.5H126V13.5ZM134 13.5H138V10.5H134V13.5ZM142 13.5H146V10.5H142V13.5ZM150 13.5H154V10.5H150V13.5ZM158 13.5H160V10.5H158V13.5ZM161.061 13.0607C161.646 12.4749 161.646 11.5251 161.061 10.9393L151.515 1.3934C150.929 0.807611 149.979 0.807611 149.393 1.3934C148.808 1.97919 148.808 2.92893 149.393 3.51472L157.879 12L149.393 20.4853C148.808 21.0711 148.808 22.0208 149.393 22.6066C149.979 23.1924 150.929 23.1924 151.515 22.6066L161.061 13.0607ZM0 13.5H2V10.5H0V13.5ZM6 13.5H10V10.5H6V13.5ZM14 13.5H18V10.5H14V13.5ZM22 13.5H26V10.5H22V13.5ZM30 13.5H34V10.5H30V13.5ZM38 13.5H42V10.5H38V13.5ZM46 13.5H50V10.5H46V13.5ZM54 13.5H58V10.5H54V13.5ZM62 13.5H66V10.5H62V13.5ZM70 13.5H74V10.5H70V13.5ZM78 13.5H82V10.5H78V13.5ZM86 13.5H90V10.5H86V13.5ZM94 13.5H98V10.5H94V13.5ZM102 13.5H106V10.5H102V13.5ZM110 13.5H114V10.5H110V13.5ZM118 13.5H122V10.5H118V13.5ZM126 13.5H130V10.5H126V13.5ZM134 13.5H138V10.5H134V13.5ZM142 13.5H146V10.5H142V13.5ZM150 13.5H154V10.5H150V13.5ZM158 13.5H160V10.5H158V13.5Z"
                fill="#FDA43E"
            />
        </svg>
        <div class="step-tour">
            <div
                class="circle checked mx-auto d-flex justify-content-center align-items-center"
            >
                <i class="fa-solid fa-check"></i>
            </div>
            <h5 class="mb-0 mt-2 text-center">CHOOSE TOUR</h5>
        </div>
        <svg
            width="162"
            height="24"
            viewBox="0 0 162 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
        >
            <path
                d="M161.061 13.0607C161.646 12.4749 161.646 11.5251 161.061 10.9393L151.515 1.3934C150.929 0.807611 149.979 0.807611 149.393 1.3934C148.808 1.97919 148.808 2.92893 149.393 3.51472L157.879 12L149.393 20.4853C148.808 21.0711 148.808 22.0208 149.393 22.6066C149.979 23.1924 150.929 23.1924 151.515 22.6066L161.061 13.0607ZM0 13.5H2V10.5H0V13.5ZM6 13.5H10V10.5H6V13.5ZM14 13.5H18V10.5H14V13.5ZM22 13.5H26V10.5H22V13.5ZM30 13.5H34V10.5H30V13.5ZM38 13.5H42V10.5H38V13.5ZM46 13.5H50V10.5H46V13.5ZM54 13.5H58V10.5H54V13.5ZM62 13.5H66V10.5H62V13.5ZM70 13.5H74V10.5H70V13.5ZM78 13.5H82V10.5H78V13.5ZM86 13.5H90V10.5H86V13.5ZM94 13.5H98V10.5H94V13.5ZM102 13.5H106V10.5H102V13.5ZM110 13.5H114V10.5H110V13.5ZM118 13.5H122V10.5H118V13.5ZM126 13.5H130V10.5H126V13.5ZM134 13.5H138V10.5H134V13.5ZM142 13.5H146V10.5H142V13.5ZM150 13.5H154V10.5H150V13.5ZM158 13.5H160V10.5H158V13.5ZM161.061 13.0607C161.646 12.4749 161.646 11.5251 161.061 10.9393L151.515 1.3934C150.929 0.807611 149.979 0.807611 149.393 1.3934C148.808 1.97919 148.808 2.92893 149.393 3.51472L157.879 12L149.393 20.4853C148.808 21.0711 148.808 22.0208 149.393 22.6066C149.979 23.1924 150.929 23.1924 151.515 22.6066L161.061 13.0607ZM0 13.5H2V10.5H0V13.5ZM6 13.5H10V10.5H6V13.5ZM14 13.5H18V10.5H14V13.5ZM22 13.5H26V10.5H22V13.5ZM30 13.5H34V10.5H30V13.5ZM38 13.5H42V10.5H38V13.5ZM46 13.5H50V10.5H46V13.5ZM54 13.5H58V10.5H54V13.5ZM62 13.5H66V10.5H62V13.5ZM70 13.5H74V10.5H70V13.5ZM78 13.5H82V10.5H78V13.5ZM86 13.5H90V10.5H86V13.5ZM94 13.5H98V10.5H94V13.5ZM102 13.5H106V10.5H102V13.5ZM110 13.5H114V10.5H110V13.5ZM118 13.5H122V10.5H118V13.5ZM126 13.5H130V10.5H126V13.5ZM134 13.5H138V10.5H134V13.5ZM142 13.5H146V10.5H142V13.5ZM150 13.5H154V10.5H150V13.5ZM158 13.5H160V10.5H158V13.5Z"
                fill="#FDA43E"
            />
        </svg>
        <div class="step-co">
            <div
                class="circle mx-auto d-flex justify-content-center align-items-center"
            >
                <i class="fa-solid fa-credit-card"></i>
            </div>
            <h5 class="mb-0 mt-2 text-center">CHECKOUT & PAY</h5>
        </div>
        <svg
            width="162"
            height="24"
            viewBox="0 0 162 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
        >
            <path
                d="M161.061 13.0607C161.646 12.4749 161.646 11.5251 161.061 10.9393L151.515 1.3934C150.929 0.807611 149.979 0.807611 149.393 1.3934C148.808 1.97919 148.808 2.92893 149.393 3.51472L157.879 12L149.393 20.4853C148.808 21.0711 148.808 22.0208 149.393 22.6066C149.979 23.1924 150.929 23.1924 151.515 22.6066L161.061 13.0607ZM0 13.5H2V10.5H0V13.5ZM6 13.5H10V10.5H6V13.5ZM14 13.5H18V10.5H14V13.5ZM22 13.5H26V10.5H22V13.5ZM30 13.5H34V10.5H30V13.5ZM38 13.5H42V10.5H38V13.5ZM46 13.5H50V10.5H46V13.5ZM54 13.5H58V10.5H54V13.5ZM62 13.5H66V10.5H62V13.5ZM70 13.5H74V10.5H70V13.5ZM78 13.5H82V10.5H78V13.5ZM86 13.5H90V10.5H86V13.5ZM94 13.5H98V10.5H94V13.5ZM102 13.5H106V10.5H102V13.5ZM110 13.5H114V10.5H110V13.5ZM118 13.5H122V10.5H118V13.5ZM126 13.5H130V10.5H126V13.5ZM134 13.5H138V10.5H134V13.5ZM142 13.5H146V10.5H142V13.5ZM150 13.5H154V10.5H150V13.5ZM158 13.5H160V10.5H158V13.5ZM161.061 13.0607C161.646 12.4749 161.646 11.5251 161.061 10.9393L151.515 1.3934C150.929 0.807611 149.979 0.807611 149.393 1.3934C148.808 1.97919 148.808 2.92893 149.393 3.51472L157.879 12L149.393 20.4853C148.808 21.0711 148.808 22.0208 149.393 22.6066C149.979 23.1924 150.929 23.1924 151.515 22.6066L161.061 13.0607ZM0 13.5H2V10.5H0V13.5ZM6 13.5H10V10.5H6V13.5ZM14 13.5H18V10.5H14V13.5ZM22 13.5H26V10.5H22V13.5ZM30 13.5H34V10.5H30V13.5ZM38 13.5H42V10.5H38V13.5ZM46 13.5H50V10.5H46V13.5ZM54 13.5H58V10.5H54V13.5ZM62 13.5H66V10.5H62V13.5ZM70 13.5H74V10.5H70V13.5ZM78 13.5H82V10.5H78V13.5ZM86 13.5H90V10.5H86V13.5ZM94 13.5H98V10.5H94V13.5ZM102 13.5H106V10.5H102V13.5ZM110 13.5H114V10.5H110V13.5ZM118 13.5H122V10.5H118V13.5ZM126 13.5H130V10.5H126V13.5ZM134 13.5H138V10.5H134V13.5ZM142 13.5H146V10.5H142V13.5ZM150 13.5H154V10.5H150V13.5ZM158 13.5H160V10.5H158V13.5Z"
                fill="#FDA43E"
            />
        </svg>
        <div class="step-enjoy">
            <div
                class="circle mx-auto d-flex justify-content-center align-items-center"
            >
                <i class="fa-solid fa-champagne-glasses"></i>
            </div>
            <h5 class="mb-0 mt-2 text-center">ENJOY!</h5>
        </div>
    </div>
</section>
<!-- Step Section End -->

<!-- Checkout Section Start -->
<section class="checkout-section py-5">
    <div class="container">
        <div class="row">
            <div class="col-7">
                <!-- Contact Details Section Start -->
                <section class="contact-details p-5">
                    <div class="header d-flex align-items-center gap-3">
                        <i class="fa-solid fa-message"></i>
                        <h2 class="my-0 text text-left">Any notes for us?</h2>
                    </div>
                    <p class="mb-0 text-white">Please fill the form for a good communication.</p>
                    <div class="user-details mt-4">
                        <div class="row">
                            <div class="col-12 d-flex flex-column">									
                                <textarea type="text" placeholder="Message.."></textarea>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Contact Details Section End -->

                <!-- Information Section Start -->
                <section class="information-section my-5">
                    <div class="accordion">
                        <div class="accordion-item wwyd-info mb-2">
                            <div class="accordion-header">
                                <button class="accordion-button" data-bs-target="#wwyd" data-bs-toggle="collapse" aria-expanded="true">
                                    <h4 class="mb-0">What will you do</h4>
                                </button>
                            </div>
                            <div class="accordion-collapse collapse show" id="wwyd">
                                <div class="accordion-body">
                                    <div class="badge white-badges gap-2">
                                        <i class="fa-solid fa-ferry"></i>
                                        BOAT TOUR
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-person-swimming"></i>
                                        SWIMMING
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-bell-concierge"></i>
                                        LUNCH
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-mountain-sun"></i>
                                        CLIFF
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-mask"></i>
                                        SNORKELING
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item lunch-info">
                            <div class="accordion-header">
                                <button class="accordion-button" data-bs-target="#wwys" data-bs-toggle="collapse">
                                    <h4 class="mb-0">Places for lunch</h4>
                                </button>
                            </div>
                            <div class="accordion-collapse collapse show" id="wwys">
                                <div class="accordion-body">
                                    <div class="badge white-badges gap-2">
                                        <i class="fa-solid fa-ferry"></i>
                                        BOAT TOUR
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-person-swimming"></i>
                                        SWIMMING
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-bell-concierge"></i>
                                        LUNCH
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-mountain-sun"></i>
                                        CLIFF
                                    </div>
                                    <div class="badge orange-badges gap-2">
                                        <i class="fa-solid fa-mask"></i>
                                        SNORKELING
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Information Section End -->
            </div>
            <div class="col-5">
                <!-- Details Payment Section Start -->
                <div class="payment-details py-4 px-5">
                    <div class="payment-header mx-0">
                        <h3 class="mb-1">Order Details</h3>
                        <hr class="border-2 mb-3 mt-1" />
                    </div>
                    <div class="row">
                        <div class="col-4 pe-0">
                            <div class="foto d-flex">
                                <img src="<?= base_url('assets/uploads/'.explode(', ', $checkout['boatPicture'])[0]); ?>" alt="Boat Picture"/>
                            </div>
                        </div>
                        <div class="col-8">
                            <h5 class="fw-bold text-start"><?= $checkout['boatName']; ?></h5>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="d-flex flex-row justify-content-between">
                            <h5 class="fw-bold mb-0">Boat Tour Type</h5>
                            <h5 class="fw-bold mb-0"><?= $checkout['boatType']; ?></h5>
                        </div>
                        <div class="col-12">
                            <p class="mb-0"><?= date('l, d-m-Y', strtotime($checkout['bookSchedule'])); ?></p>
                        </div>
                    </div>
                    <hr class="border-2 my-2" />
                    <div class="d-flex flex-row justify-content-between">
                        <h5 class="fw-bold mb-0">Boat Price</h5>
                        <h5 class="fw-bold mb-0"><?= number_format($checkout['boatPrice']); ?> IDR</h5>
                    </div>
                    <div class="d-flex flex-row justify-content-between">
                        <h5 class="fw-bold mb-0">Tour Price</h5>
                        <h5 class="fw-bold mb-0"><?= number_format($checkout['packagePrice']); ?> IDR</h5>
                    </div>
                    <p class="mb-0">Passengger :</p>
                    <?php if ($checkout['bookAdults'] != 0) { ?>
                    <div class="d-flex justify-content-between">
                        <p class="item-name mb-1">Adults x <?= $checkout['bookAdults'] ?></p>
                        <p class="item-price mb-1"><?= number_format($checkout['bookAdults']*400000) ?></p>
                    </div>
                    <?php } ?>
                    <?php if ($checkout['bookTeens'] != 0) { ?>
                    <div class="d-flex justify-content-between">
                        <p class="item-name mb-1">Teens x <?= $checkout['bookTeens'] ?></p>
                        <p class="item-price mb-1"><?= number_format($checkout['bookTeens']*250000) ?></p>
                    </div>
                    <?php } ?>
                    <?php if ($checkout['bookToddlers'] != 0) { ?>
                    <div class="d-flex justify-content-between">
                        <p class="item-name mb-1">Toddlers x <?= $checkout['bookToddlers'] ?></p>
                        <p class="item-price mb-1"><?= number_format($checkout['bookToddlers']*50000) ?></p>
                    </div>
                    <?php } ?>
                    <p class="mb-0">Extras :</p>
                    <div class="row g-0 p-0">
                    <?php 
                    $id=0;
                    $totalExtraPrice=0;
                    if ($checkout['bookextraIds']) {
                    foreach(explode(',', $checkout['bookextraIds']) as $extra):
                    ?>
                        <div class="d-flex justify-content-between">
                            <p class="item-name mb-1"><?= explode(', ', $checkout['bookextraNames'])[$id] ?></p>
                            <p class="item-price mb-1"><?= number_format(explode(', ', $checkout['bookextraPrices'])[$id]) ?></p>
                        </div>
                    <?php 
                        $totalExtraPrice += explode(', ', $checkout['bookextraPrices'])[$id];
                        $id++;
                        endforeach;
                    }else { 
                    ?>
                        <div class="d-flex justify-content-center">
                            <p>- NO EXTRA -</p>
                        </div>
                    <?php } ?>
                    </div>
                    <hr class="border-2 mb-3 mt-2" />
                    <div class="d-flex justify-content-between">
                        <p class="discount-name mb-1">Discount 10%</p>
                        <p class="discount-name mb-1">-<?= number_format($checkout['bookPrice']*0.1) ?></p>
                    </div>
                    <div class="d-flex justify-content-between w-100">
                        <p class="discount-name mb-0 text-start" id="promoName"></p>
                        <p class="discount-name mb-0 text-end" id="promoPrice"></p>
                        <input type="number" id="procodeId" hidden>
                    </div>
                    <div class="procode-search my-3 d-flex flex-column align-items-center">
                        <input class="w-100 text-center" type="text" placeholder="Have a promo code?" id="procodeName" <?= $checkout['procodeName']=='NO PROMO'?'':'value="'.$checkout['procodeName'].'"'; ?>>
                        <p class="mb-0" id="founded">Promo code founded!</p>
                    </div>
                    <div class="total-price d-flex justify-content-between">
                        <h5 class="fw-bold mb-0">Total Price</h5>
                        <h5 class="fw-bold mb-0" id="showPrice"><?= number_format($checkout['bookPrice']); ?> IDR</h5>
                        <input type="number" id="totalPrice" value="<?= $checkout['bookPrice']; ?>" hidden>
                    </div>
                    <hr class="border-2 my-2" />
                    <button class="btn-secondary w-100" id="pay-button">PAY NOW!</button>
                </div>
                <!-- Detail Payment Section End -->
            </div>
        </div>
    </div>
</section>
<!-- Checkout Section End -->

<script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="<?= $clientKey?>"></script>
<script type="text/javascript">
    var founded = document.querySelector('#founded');
    var promoName = document.querySelector('#promoName');
    var promoPrice = document.querySelector('#promoPrice');
    var procode = document.querySelector('#procodeName');
    var bookPrice = document.querySelector('#totalPrice');
    var showPrice = document.querySelector('#showPrice');
    var procodeId = document.querySelector('#procodeId');
    var totalPrice = <?= $checkout['boatPrice'] + $checkout['packagePrice'] + $totalExtraPrice + ($checkout['bookAdults']*400000)+($checkout['bookTeens']*250000)+($checkout['bookToddlers']*50000); ?>;
    var finalPrice = totalPrice - (totalPrice * 0.1);

    function checkPromo() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.status == 200) {
                if (xhr.readyState == 4 && xhr.responseText != 'notfound') {
                    founded.style.display = 'contents';
                    procode.setAttribute('readonly', true);
                    var data = JSON.parse(xhr.responseText);
                    showPromo(data);
                }else {
                    founded.style.display = 'none';
                    promoName.style.display = 'none';
                    promoPrice.style.display = 'none';
                }
            }
        }

        xhr.open('GET', "<?= base_url('user/Checkout/checkPromo/'); ?>"+(procodeName.value? procodeName.value : "NO PROMO"), true);
        xhr.send();
    }

    checkPromo();

    procode.addEventListener('keyup', function() {
        checkPromo();
    });


    function showPromo(data) {
        promoName.style.display = 'block';
        promoPrice.style.display = 'block';
        procodeId.value = data.procodeId;
        promoName.textContent = data.procodeName;
        promoDiscount = finalPrice * (data.procodeDiscount/100);
        bookPrice.value = finalPrice - promoDiscount;
        promoPrice.textContent = '-' + new Intl.NumberFormat({style: 'currency',}).format(promoDiscount);
        showPrice.textContent = new Intl.NumberFormat({style: 'currency',}).format(bookPrice.value) + ' IDR';
    }


    document.getElementById('pay-button').onclick = function(){

        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    const token = xhr.responseText;
                    snap.pay(token, {
                        onSuccess: function(result){
                            var url = "<?= base_url('user/Checkout/paymentSuccess/'.$checkout['bookId']) ?>/"+(procodeId.value?procodeId.value:1)+"/"+bookPrice.value;
                            window.location.href = url;
                        },
                        onPending: function(result){
                            
                        },
                        onError: function(result){
                            
                        },
                    });
                }else {
                    console.error("Failed to get token:", xhr.statusText);
                }
            }   
        }

        var params = "bookPrice=" + parseFloat(bookPrice.value)+ "&bookStatus=" + "<?= $checkout['bookStatus'] ?>";    
        console.log(params);
        xhr.open('POST', "<?= base_url('user/Checkout/initMidtrans') ?>", true);
        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhr.send(params);
    };

    
</script>